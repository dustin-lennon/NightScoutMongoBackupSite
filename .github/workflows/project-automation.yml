name: Project Automation

on:
  issues:
    types: [opened, reopened, closed]
  pull_request:
    types: [opened, reopened, ready_for_review, closed]

permissions:
  contents: read
  issues: write
  pull-requests: write
  repository-projects: write
  # Note: Organization-level project access requires the workflow to be granted
  # organization permissions in Settings > Actions > General > Workflow permissions

jobs:
  add-to-project:
    name: Add Issues and PRs to Project
    runs-on: ubuntu-latest
    env:
      PROJECT_NUMBER: ${{ vars.PROJECT_NUMBER }}
      GH_TOKEN: ${{ secrets.ORG_PROJECT_TOKEN }}
    steps:
      - name: List available projects
        if: env.PROJECT_NUMBER == '' || env.PROJECT_NUMBER == null
        uses: actions/github-script@v8
        continue-on-error: true
        with:
          script: |
            console.log('üìã Listing available projects in organization Stelth2000-Inc...');
            const query = `
              query($owner: String!, $first: Int!) {
                organization(login: $owner) {
                  projectsV2(first: $first) {
                    nodes {
                      number
                      title
                      public
                      url
                    }
                  }
                }
              }
            `;
            try {
              const result = await github.graphql(query, {
                owner: 'Stelth2000-Inc',
                first: 20
              });

              if (result.organization && result.organization.projectsV2 && result.organization.projectsV2.nodes.length > 0) {
                console.log('‚úÖ Available projects:');
                result.organization.projectsV2.nodes.forEach(project => {
                  console.log(`   - Project #${project.number}: ${project.title} (${project.public ? 'Public' : 'Private'})`);
                  console.log(`     URL: ${project.url}`);
                });
                console.log('\nüí° To use a project, set the PROJECT_NUMBER repository variable to the project number above.');
              } else {
                console.log('‚ö†Ô∏è No projects found in organization. You may need to create a project first.');
              }
            } catch (error) {
              console.log('‚ö†Ô∏è Could not list projects. This may be due to permissions.');
              console.log('   Error: ' + error.message);
            }

      - name: Get project ID
        id: project
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.ORG_PROJECT_TOKEN }}
          script: |
            const projectNumber = parseInt(process.env.PROJECT_NUMBER || '1');
            console.log(`üîç Looking for ProjectV2 number ${projectNumber} in organization Stelth2000-Inc`);
            console.log(`üìù PROJECT_NUMBER env var: ${process.env.PROJECT_NUMBER || 'not set (using default 1)'}`);

            const query = `
              query($owner: String!, $projectNumber: Int!) {
                organization(login: $owner) {
                  projectV2(number: $projectNumber) {
                    id
                    title
                    public
                  }
                }
              }
            `;
            const variables = {
              owner: 'Stelth2000-Inc',
              projectNumber: projectNumber
            };
            try {
              console.log(`üì§ Executing GraphQL query with variables:`, JSON.stringify(variables, null, 2));
              const result = await github.graphql(query, variables);
              console.log(`üì• GraphQL response:`, JSON.stringify(result, null, 2));

              if (!result.organization) {
                core.setFailed('‚ùå Organization \'Stelth2000-Inc\' not found or not accessible. Check organization permissions.');
                return;
              }

              if (!result.organization.projectV2) {
                // Try to list available projects for better error message
                let availableProjects = '';
                try {
                  const listQuery = `
                    query($owner: String!, $first: Int!) {
                      organization(login: $owner) {
                        projectsV2(first: $first) {
                          nodes {
                            number
                            title
                          }
                        }
                      }
                    }
                  `;
                  const listResult = await github.graphql(listQuery, {
                    owner: 'Stelth2000-Inc',
                    first: 10
                  });
                  if (listResult.organization && listResult.organization.projectsV2 && listResult.organization.projectsV2.nodes.length > 0) {
                    availableProjects = '\n\nAvailable projects:\n' +
                      listResult.organization.projectsV2.nodes.map(p => `  - Project #${p.number}: ${p.title}`).join('\n') +
                      '\n\nüí° Set the PROJECT_NUMBER repository variable to one of the project numbers above.';
                  }
                } catch (e) {
                  // Ignore errors when listing projects
                }

                core.setFailed(
                  '‚ùå ProjectV2 with number ' + projectNumber + ' not found in organization Stelth2000-Inc.\n\n' +
                  'Debugging info:\n' +
                  '- Organization: Stelth2000-Inc\n' +
                  '- Project Number: ' + projectNumber + '\n' +
                  '- Response: ' + JSON.stringify(result, null, 2) + '\n\n' +
                  'Please verify:\n' +
                  '1. The project exists at: https://github.com/orgs/Stelth2000-Inc/projects/' + projectNumber + '\n' +
                  '2. The project is accessible to the repository\n' +
                  '3. The workflow has organization-level permissions enabled\n' +
                  '4. Set the PROJECT_NUMBER repository variable in Settings > Secrets and variables > Actions > Variables' +
                  availableProjects
                );
                return;
              }

              const projectId = result.organization.projectV2.id;
              const projectTitle = result.organization.projectV2.title;
              const isPublic = result.organization.projectV2.public;
              core.setOutput('projectId', projectId);
              console.log(`‚úÖ Found project: ${projectTitle} (${projectId})`);
              console.log(`üìä Project visibility: ${isPublic ? 'Public' : 'Private'}`);
              return projectId;
            } catch (error) {
              console.error(`‚ùå GraphQL Error:`, error);
              console.error(`üìã Error details:`, JSON.stringify(error, null, 2));

              if (error.errors) {
                console.error(`üö® GraphQL Errors:`, JSON.stringify(error.errors, null, 2));
                error.errors.forEach(err => {
                  console.error(`   - ${err.type}: ${err.message}`);
                  if (err.path) {
                    console.error(`     Path: ${err.path.join('.')}`);
                  }
                });
              }

              if (error.errors && error.errors.some(e => e.type === 'NOT_FOUND')) {
                // Try to list available projects for better error message
                let availableProjects = '';
                try {
                  const listQuery = `
                    query($owner: String!, $first: Int!) {
                      organization(login: $owner) {
                        projectsV2(first: $first) {
                          nodes {
                            number
                            title
                          }
                        }
                      }
                    }
                  `;
                  const listResult = await github.graphql(listQuery, {
                    owner: 'Stelth2000-Inc',
                    first: 10
                  });
                  if (listResult.organization && listResult.organization.projectsV2 && listResult.organization.projectsV2.nodes.length > 0) {
                    availableProjects = '\n\nAvailable projects:\n' +
                      listResult.organization.projectsV2.nodes.map(p => `  - Project #${p.number}: ${p.title}`).join('\n') +
                      '\n\nüí° Set the PROJECT_NUMBER repository variable to one of the project numbers above.';
                  }
                } catch (e) {
                  // Ignore errors when listing projects
                }

                core.setFailed(
                  '‚ùå ProjectV2 with number ' + projectNumber + ' not found in organization Stelth2000-Inc.\n\n' +
                  'Full error: ' + error.message + '\n' +
                  'Errors: ' + JSON.stringify(error.errors, null, 2) + '\n\n' +
                  'Please verify:\n' +
                  '1. The project exists at: https://github.com/orgs/Stelth2000-Inc/projects/' + projectNumber + '\n' +
                  '2. The workflow has organization-level permissions enabled\n' +
                  '3. The repository has access to organization projects\n' +
                  '4. Set the PROJECT_NUMBER repository variable in Settings > Secrets and variables > Actions > Variables' +
                  availableProjects
                );
              } else {
                throw error;
              }
            }

      - name: Get Status field ID
        id: status-field
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.ORG_PROJECT_TOKEN }}
          script: |
            const projectNumber = parseInt(process.env.PROJECT_NUMBER || '1');
            const query = `
              query($owner: String!, $projectNumber: Int!) {
                organization(login: $owner) {
                  projectV2(number: $projectNumber) {
                    field(name: "Status") {
                      ... on ProjectV2SingleSelectField {
                        id
                        options {
                          id
                          name
                        }
                      }
                    }
                  }
                }
              }
            `;
            const variables = {
              owner: 'Stelth2000-Inc',
              projectNumber: projectNumber
            };
            try {
              const result = await github.graphql(query, variables);

              if (!result.organization.projectV2) {
                core.setFailed(`‚ùå ProjectV2 with number ${projectNumber} not found.`);
                return;
              }

              const statusField = result.organization.projectV2.field;
              if (!statusField) {
                core.setFailed(`‚ùå Status field not found in project. Please add a "Status" field to your project.`);
                return;
              }

              core.setOutput('fieldId', statusField.id);

              // Find or create status options
              const options = statusField.options || [];
              const todoOption = options.find(opt => opt.name === 'Todo') || options.find(opt => opt.name === 'Backlog');
              const inProgressOption = options.find(opt => opt.name === 'In Progress');
              const doneOption = options.find(opt => opt.name === 'Done') || options.find(opt => opt.name === 'Completed');

              core.setOutput('todoOptionId', todoOption?.id || '');
              core.setOutput('inProgressOptionId', inProgressOption?.id || '');
              core.setOutput('doneOptionId', doneOption?.id || '');

              return { fieldId: statusField.id, options };
            } catch (error) {
              if (error.errors && error.errors.some(e => e.type === 'NOT_FOUND')) {
                core.setFailed(`‚ùå ProjectV2 with number ${projectNumber} not found.`);
              } else {
                throw error;
              }
            }

      - name: Add issue to project
        if: github.event_name == 'issues' && (github.event.action == 'opened' || github.event.action == 'reopened')
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.ORG_PROJECT_TOKEN }}
          script: |
            const projectId = '${{ steps.project.outputs.projectId }}';
            const issueId = context.payload.issue.node_id;
            const statusFieldId = '${{ steps.status-field.outputs.fieldId }}';
            const todoOptionId = '${{ steps.status-field.outputs.todoOptionId }}';

            const mutation = `
              mutation($projectId: ID!, $contentId: ID!) {
                addProjectV2ItemById(input: {
                  projectId: $projectId
                  contentId: $contentId
                }) {
                  item {
                    id
                  }
                }
              }
            `;

            try {
              await github.graphql(mutation, {
                projectId: projectId,
                contentId: issueId
              });

              // Set status to Todo if we have the option
              if (todoOptionId) {
                const updateMutation = `
                  mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                    updateProjectV2ItemFieldValue(input: {
                      projectId: $projectId
                      itemId: $itemId
                      fieldId: $fieldId
                      value: {
                        singleSelectOptionId: $optionId
                      }
                    }) {
                      clientMutationId
                    }
                  }
                `;
                // Note: We'd need the item ID from the add mutation response
                // This is a simplified version - you may need to query for the item first
              }

              console.log(`‚úÖ Added issue #${context.payload.issue.number} to project`);
            } catch (error) {
              // Item might already be in project
              if (error.message.includes('already exists')) {
                console.log(`‚ÑπÔ∏è Issue #${context.payload.issue.number} already in project`);
              } else {
                throw error;
              }
            }

      - name: Add PR to project
        if: github.event_name == 'pull_request' && (github.event.action == 'opened' || github.event.action == 'reopened' || github.event.action == 'ready_for_review')
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.ORG_PROJECT_TOKEN }}
          script: |
            const projectId = '${{ steps.project.outputs.projectId }}';
            const prId = context.payload.pull_request.node_id;
            const statusFieldId = '${{ steps.status-field.outputs.fieldId }}';
            const inProgressOptionId = '${{ steps.status-field.outputs.inProgressOptionId }}';

            const mutation = `
              mutation($projectId: ID!, $contentId: ID!) {
                addProjectV2ItemById(input: {
                  projectId: $projectId
                  contentId: $contentId
                }) {
                  item {
                    id
                  }
                }
              }
            `;

            try {
              const result = await github.graphql(mutation, {
                projectId: projectId,
                contentId: prId
              });

              console.log(`‚úÖ Added PR #${context.payload.pull_request.number} to project`);

              // Try to set status to "In Progress" if option exists
              if (inProgressOptionId && result.addProjectV2ItemById?.item?.id) {
                const itemId = result.addProjectV2ItemById.item.id;
                const updateMutation = `
                  mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                    updateProjectV2ItemFieldValue(input: {
                      projectId: $projectId
                      itemId: $itemId
                      fieldId: $fieldId
                      value: {
                        singleSelectOptionId: $optionId
                      }
                    }) {
                      clientMutationId
                    }
                  }
                `;

                try {
                  await github.graphql(updateMutation, {
                    projectId: projectId,
                    itemId: itemId,
                    fieldId: statusFieldId,
                    optionId: inProgressOptionId
                  });
                  console.log(`‚úÖ Set PR status to "In Progress"`);
                } catch (updateError) {
                  console.log(`‚ö†Ô∏è Could not update status: ${updateError.message}`);
                }
              }
            } catch (error) {
              // Item might already be in project
              if (error.message.includes('already exists') || error.message.includes('already added')) {
                console.log(`‚ÑπÔ∏è PR #${context.payload.pull_request.number} already in project`);
              } else {
                throw error;
              }
            }

      - name: Update status on PR merged/closed
        if: github.event_name == 'pull_request' && github.event.action == 'closed'
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.ORG_PROJECT_TOKEN }}
          script: |
            const projectId = '${{ steps.project.outputs.projectId }}';
            const prId = context.payload.pull_request.node_id;
            const isMerged = context.payload.pull_request.merged === true;
            const statusFieldId = '${{ steps.status-field.outputs.fieldId }}';
            const doneOptionId = '${{ steps.status-field.outputs.doneOptionId }}';

            // Only update to "Done" if PR was merged, not just closed
            if (!isMerged) {
              console.log(`‚ÑπÔ∏è PR #${context.payload.pull_request.number} was closed without merging, skipping status update`);
              return;
            }

            // First, find the project item for this PR
            const query = `
              query($projectId: ID!, $contentId: ID!) {
                node(id: $projectId) {
                  ... on ProjectV2 {
                    items(first: 100) {
                      nodes {
                        id
                        content {
                          ... on PullRequest {
                            id
                          }
                        }
                      }
                    }
                  }
                }
              }
            `;

            try {
              const projectData = await github.graphql(query, {
                projectId: projectId,
                contentId: prId
              });

              const item = projectData.node.items.nodes.find(
                item => item.content?.id === prId
              );

              if (item && doneOptionId) {
                const updateMutation = `
                  mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                    updateProjectV2ItemFieldValue(input: {
                      projectId: $projectId
                      itemId: $itemId
                      fieldId: $fieldId
                      value: {
                        singleSelectOptionId: $optionId
                      }
                    }) {
                      clientMutationId
                    }
                  }
                `;

                await github.graphql(updateMutation, {
                  projectId: projectId,
                  itemId: item.id,
                  fieldId: statusFieldId,
                  optionId: doneOptionId
                });

                console.log(`‚úÖ Updated PR #${context.payload.pull_request.number} status to "Done"`);
              }
            } catch (error) {
              console.log(`‚ö†Ô∏è Could not update PR status: ${error.message}`);
            }

      - name: Update status on issue closed
        if: github.event_name == 'issues' && github.event.action == 'closed'
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.ORG_PROJECT_TOKEN }}
          script: |
            const projectId = '${{ steps.project.outputs.projectId }}';
            const issueId = context.payload.issue.node_id;
            const statusFieldId = '${{ steps.status-field.outputs.fieldId }}';
            const doneOptionId = '${{ steps.status-field.outputs.doneOptionId }}';

            // Find the project item for this issue
            const query = `
              query($projectId: ID!) {
                node(id: $projectId) {
                  ... on ProjectV2 {
                    items(first: 100) {
                      nodes {
                        id
                        content {
                          ... on Issue {
                            id
                          }
                        }
                      }
                    }
                  }
                }
              }
            `;

            try {
              const projectData = await github.graphql(query, {
                projectId: projectId
              });

              const item = projectData.node.items.nodes.find(
                item => item.content?.id === issueId
              );

              if (item && doneOptionId) {
                const updateMutation = `
                  mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                    updateProjectV2ItemFieldValue(input: {
                      projectId: $projectId
                      itemId: $itemId
                      fieldId: $fieldId
                      value: {
                        singleSelectOptionId: $optionId
                      }
                    }) {
                      clientMutationId
                    }
                  }
                `;

                await github.graphql(updateMutation, {
                  projectId: projectId,
                  itemId: item.id,
                  fieldId: statusFieldId,
                  optionId: doneOptionId
                });

                console.log(`‚úÖ Updated issue #${context.payload.issue.number} status to "Done"`);
              }
            } catch (error) {
              console.log(`‚ö†Ô∏è Could not update issue status: ${error.message}`);
            }
