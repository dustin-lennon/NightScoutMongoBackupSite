name: Project Automation

on:
  issues:
    types: [opened, reopened, closed]
  pull_request:
    types: [opened, reopened, ready_for_review, closed]

permissions:
  contents: read
  issues: write
  pull-requests: write
  repository-projects: write

jobs:
  add-to-project:
    name: Add Issues and PRs to Project
    runs-on: ubuntu-latest
    env:
      PROJECT_NUMBER: ${{ vars.PROJECT_NUMBER || '1' }}
    steps:
      - name: Get project ID
        id: project
        uses: actions/github-script@v8
        with:
          script: |
            const projectNumber = parseInt(process.env.PROJECT_NUMBER || '1');
            const query = `
              query($owner: String!, $projectNumber: Int!) {
                organization(login: $owner) {
                  projectV2(number: $projectNumber) {
                    id
                    title
                  }
                }
              }
            `;
            const variables = {
              owner: 'Stelth2000-Inc',
              projectNumber: projectNumber
            };
            try {
              const result = await github.graphql(query, variables);
              
              if (!result.organization.projectV2) {
                core.setFailed(`❌ ProjectV2 with number ${projectNumber} not found in organization Stelth2000-Inc. Please create a project or update the PROJECT_NUMBER variable.`);
                return;
              }
              
              const projectId = result.organization.projectV2.id;
              const projectTitle = result.organization.projectV2.title;
              core.setOutput('projectId', projectId);
              console.log(`✅ Found project: ${projectTitle} (${projectId})`);
              return projectId;
            } catch (error) {
              if (error.errors && error.errors.some(e => e.type === 'NOT_FOUND')) {
                core.setFailed(`❌ ProjectV2 with number ${projectNumber} not found in organization Stelth2000-Inc. Please create a project or update the PROJECT_NUMBER variable.`);
              } else {
                throw error;
              }
            }

      - name: Get Status field ID
        id: status-field
        uses: actions/github-script@v8
        with:
          script: |
            const projectNumber = parseInt(process.env.PROJECT_NUMBER || '1');
            const query = `
              query($owner: String!, $projectNumber: Int!) {
                organization(login: $owner) {
                  projectV2(number: $projectNumber) {
                    field(name: "Status") {
                      ... on ProjectV2SingleSelectField {
                        id
                        options {
                          id
                          name
                        }
                      }
                    }
                  }
                }
              }
            `;
            const variables = {
              owner: 'Stelth2000-Inc',
              projectNumber: projectNumber
            };
            try {
              const result = await github.graphql(query, variables);
              
              if (!result.organization.projectV2) {
                core.setFailed(`❌ ProjectV2 with number ${projectNumber} not found.`);
                return;
              }
              
              const statusField = result.organization.projectV2.field;
              if (!statusField) {
                core.setFailed(`❌ Status field not found in project. Please add a "Status" field to your project.`);
                return;
              }
              
              core.setOutput('fieldId', statusField.id);

              // Find or create status options
              const options = statusField.options || [];
              const todoOption = options.find(opt => opt.name === 'Todo') || options.find(opt => opt.name === 'Backlog');
              const inProgressOption = options.find(opt => opt.name === 'In Progress');
              const doneOption = options.find(opt => opt.name === 'Done') || options.find(opt => opt.name === 'Completed');

              core.setOutput('todoOptionId', todoOption?.id || '');
              core.setOutput('inProgressOptionId', inProgressOption?.id || '');
              core.setOutput('doneOptionId', doneOption?.id || '');

              return { fieldId: statusField.id, options };
            } catch (error) {
              if (error.errors && error.errors.some(e => e.type === 'NOT_FOUND')) {
                core.setFailed(`❌ ProjectV2 with number ${projectNumber} not found.`);
              } else {
                throw error;
              }
            }

      - name: Add issue to project
        if: github.event_name == 'issues' && (github.event.action == 'opened' || github.event.action == 'reopened')
        uses: actions/github-script@v8
        with:
          script: |
            const projectId = '${{ steps.project.outputs.projectId }}';
            const issueId = context.payload.issue.node_id;
            const statusFieldId = '${{ steps.status-field.outputs.fieldId }}';
            const todoOptionId = '${{ steps.status-field.outputs.todoOptionId }}';

            const mutation = `
              mutation($projectId: ID!, $contentId: ID!) {
                addProjectV2ItemById(input: {
                  projectId: $projectId
                  contentId: $contentId
                }) {
                  item {
                    id
                  }
                }
              }
            `;

            try {
              await github.graphql(mutation, {
                projectId: projectId,
                contentId: issueId
              });

              // Set status to Todo if we have the option
              if (todoOptionId) {
                const updateMutation = `
                  mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                    updateProjectV2ItemFieldValue(input: {
                      projectId: $projectId
                      itemId: $itemId
                      fieldId: $fieldId
                      value: {
                        singleSelectOptionId: $optionId
                      }
                    }) {
                      clientMutationId
                    }
                  }
                `;
                // Note: We'd need the item ID from the add mutation response
                // This is a simplified version - you may need to query for the item first
              }

              console.log(`✅ Added issue #${context.payload.issue.number} to project`);
            } catch (error) {
              // Item might already be in project
              if (error.message.includes('already exists')) {
                console.log(`ℹ️ Issue #${context.payload.issue.number} already in project`);
              } else {
                throw error;
              }
            }

      - name: Add PR to project
        if: github.event_name == 'pull_request' && (github.event.action == 'opened' || github.event.action == 'reopened' || github.event.action == 'ready_for_review')
        uses: actions/github-script@v8
        with:
          script: |
            const projectId = '${{ steps.project.outputs.projectId }}';
            const prId = context.payload.pull_request.node_id;
            const statusFieldId = '${{ steps.status-field.outputs.fieldId }}';
            const inProgressOptionId = '${{ steps.status-field.outputs.inProgressOptionId }}';

            const mutation = `
              mutation($projectId: ID!, $contentId: ID!) {
                addProjectV2ItemById(input: {
                  projectId: $projectId
                  contentId: $contentId
                }) {
                  item {
                    id
                  }
                }
              }
            `;

            try {
              const result = await github.graphql(mutation, {
                projectId: projectId,
                contentId: prId
              });

              console.log(`✅ Added PR #${context.payload.pull_request.number} to project`);

              // Try to set status to "In Progress" if option exists
              if (inProgressOptionId && result.addProjectV2ItemById?.item?.id) {
                const itemId = result.addProjectV2ItemById.item.id;
                const updateMutation = `
                  mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                    updateProjectV2ItemFieldValue(input: {
                      projectId: $projectId
                      itemId: $itemId
                      fieldId: $fieldId
                      value: {
                        singleSelectOptionId: $optionId
                      }
                    }) {
                      clientMutationId
                    }
                  }
                `;

                try {
                  await github.graphql(updateMutation, {
                    projectId: projectId,
                    itemId: itemId,
                    fieldId: statusFieldId,
                    optionId: inProgressOptionId
                  });
                  console.log(`✅ Set PR status to "In Progress"`);
                } catch (updateError) {
                  console.log(`⚠️ Could not update status: ${updateError.message}`);
                }
              }
            } catch (error) {
              // Item might already be in project
              if (error.message.includes('already exists') || error.message.includes('already added')) {
                console.log(`ℹ️ PR #${context.payload.pull_request.number} already in project`);
              } else {
                throw error;
              }
            }

      - name: Update status on PR merged/closed
        if: github.event_name == 'pull_request' && github.event.action == 'closed'
        uses: actions/github-script@v8
        with:
          script: |
            const projectId = '${{ steps.project.outputs.projectId }}';
            const prId = context.payload.pull_request.node_id;
            const isMerged = context.payload.pull_request.merged === true;
            const statusFieldId = '${{ steps.status-field.outputs.fieldId }}';
            const doneOptionId = '${{ steps.status-field.outputs.doneOptionId }}';

            // Only update to "Done" if PR was merged, not just closed
            if (!isMerged) {
              console.log(`ℹ️ PR #${context.payload.pull_request.number} was closed without merging, skipping status update`);
              return;
            }

            // First, find the project item for this PR
            const query = `
              query($projectId: ID!, $contentId: ID!) {
                node(id: $projectId) {
                  ... on ProjectV2 {
                    items(first: 100) {
                      nodes {
                        id
                        content {
                          ... on PullRequest {
                            id
                          }
                        }
                      }
                    }
                  }
                }
              }
            `;

            try {
              const projectData = await github.graphql(query, {
                projectId: projectId,
                contentId: prId
              });

              const item = projectData.node.items.nodes.find(
                item => item.content?.id === prId
              );

              if (item && doneOptionId) {
                const updateMutation = `
                  mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                    updateProjectV2ItemFieldValue(input: {
                      projectId: $projectId
                      itemId: $itemId
                      fieldId: $fieldId
                      value: {
                        singleSelectOptionId: $optionId
                      }
                    }) {
                      clientMutationId
                    }
                  }
                `;

                await github.graphql(updateMutation, {
                  projectId: projectId,
                  itemId: item.id,
                  fieldId: statusFieldId,
                  optionId: doneOptionId
                });

                console.log(`✅ Updated PR #${context.payload.pull_request.number} status to "Done"`);
              }
            } catch (error) {
              console.log(`⚠️ Could not update PR status: ${error.message}`);
            }

      - name: Update status on issue closed
        if: github.event_name == 'issues' && github.event.action == 'closed'
        uses: actions/github-script@v8
        with:
          script: |
            const projectId = '${{ steps.project.outputs.projectId }}';
            const issueId = context.payload.issue.node_id;
            const statusFieldId = '${{ steps.status-field.outputs.fieldId }}';
            const doneOptionId = '${{ steps.status-field.outputs.doneOptionId }}';

            // Find the project item for this issue
            const query = `
              query($projectId: ID!) {
                node(id: $projectId) {
                  ... on ProjectV2 {
                    items(first: 100) {
                      nodes {
                        id
                        content {
                          ... on Issue {
                            id
                          }
                        }
                      }
                    }
                  }
                }
              }
            `;

            try {
              const projectData = await github.graphql(query, {
                projectId: projectId
              });

              const item = projectData.node.items.nodes.find(
                item => item.content?.id === issueId
              );

              if (item && doneOptionId) {
                const updateMutation = `
                  mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                    updateProjectV2ItemFieldValue(input: {
                      projectId: $projectId
                      itemId: $itemId
                      fieldId: $fieldId
                      value: {
                        singleSelectOptionId: $optionId
                      }
                    }) {
                      clientMutationId
                    }
                  }
                `;

                await github.graphql(updateMutation, {
                  projectId: projectId,
                  itemId: item.id,
                  fieldId: statusFieldId,
                  optionId: doneOptionId
                });

                console.log(`✅ Updated issue #${context.payload.issue.number} status to "Done"`);
              }
            } catch (error) {
              console.log(`⚠️ Could not update issue status: ${error.message}`);
            }
