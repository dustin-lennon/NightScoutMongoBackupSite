name: Project PR Review Status

on:
  pull_request:
    types: [ready_for_review, review_requested]

permissions:
  contents: read
  pull-requests: read
  repository-projects: write

jobs:
  update-review-status:
    name: Update Project Status for Reviews
    runs-on: ubuntu-latest
    steps:
      - name: Get project ID
        id: project
        uses: actions/github-script@v8
        with:
          script: |
            const query = `
              query($owner: String!, $projectNumber: Int!) {
                organization(login: $owner) {
                  projectV2(number: $projectNumber) {
                    id
                  }
                }
              }
            `;
            const result = await github.graphql(query, {
              owner: 'Stelth2000-Inc',
              projectNumber: 1
            });
            core.setOutput('projectId', result.organization.projectV2.id);

      - name: Get Status field and options
        id: status-field
        uses: actions/github-script@v8
        with:
          script: |
            const query = `
              query($owner: String!, $projectNumber: Int!) {
                organization(login: $owner) {
                  projectV2(number: $projectNumber) {
                    field(name: "Status") {
                      ... on ProjectV2SingleSelectField {
                        id
                        options {
                          id
                          name
                        }
                      }
                    }
                  }
                }
              }
            `;
            const result = await github.graphql(query, {
              owner: 'Stelth2000-Inc',
              projectNumber: 1
            });
            const statusField = result.organization.projectV2.field;
            const options = statusField.options || [];

            // Find status options (case-insensitive)
            const findOption = (name) => {
              const lowerName = name.toLowerCase();
              return options.find(opt =>
                opt.name.toLowerCase() === lowerName ||
                opt.name.toLowerCase().includes(lowerName)
              );
            };

            const inReviewOption = findOption('In Review') || findOption('Review') || findOption('Ready for Review');
            const inProgressOption = findOption('In Progress') || findOption('In Progress');

            core.setOutput('fieldId', statusField.id);
            core.setOutput('inReviewOptionId', inReviewOption?.id || '');
            core.setOutput('inProgressOptionId', inProgressOption?.id || '');

      - name: Update status to In Review
        if: github.event.action == 'ready_for_review' || github.event.action == 'review_requested'
        uses: actions/github-script@v8
        with:
          script: |
            const projectId = '${{ steps.project.outputs.projectId }}';
            const prId = context.payload.pull_request.node_id;
            const statusFieldId = '${{ steps.status-field.outputs.fieldId }}';
            const inReviewOptionId = '${{ steps.status-field.outputs.inReviewOptionId }}';
            const inProgressOptionId = '${{ steps.status-field.outputs.inProgressOptionId }}';

            // Use In Review if available, otherwise fall back to In Progress
            const targetOptionId = inReviewOptionId || inProgressOptionId;

            if (!targetOptionId) {
              console.log('⚠️ No suitable status option found. Please configure status options in the project.');
              return;
            }

            // Find the project item for this PR
            const query = `
              query($projectId: ID!) {
                node(id: $projectId) {
                  ... on ProjectV2 {
                    items(first: 100) {
                      nodes {
                        id
                        content {
                          ... on PullRequest {
                            id
                            number
                          }
                        }
                      }
                    }
                  }
                }
              }
            `;

            try {
              const projectData = await github.graphql(query, {
                projectId: projectId
              });

              const item = projectData.node.items.nodes.find(
                item => item.content?.id === prId
              );

              if (item) {
                const updateMutation = `
                  mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                    updateProjectV2ItemFieldValue(input: {
                      projectId: $projectId
                      itemId: $itemId
                      fieldId: $fieldId
                      value: {
                        singleSelectOptionId: $optionId
                      }
                    }) {
                      clientMutationId
                    }
                  }
                `;

                await github.graphql(updateMutation, {
                  projectId: projectId,
                  itemId: item.id,
                  fieldId: statusFieldId,
                  optionId: targetOptionId
                });

                const statusName = inReviewOptionId ? 'In Review' : 'In Progress';
                console.log(`✅ Updated PR #${context.payload.pull_request.number} status to "${statusName}"`);
              } else {
                console.log(`ℹ️ PR #${context.payload.pull_request.number} not found in project`);
              }
            } catch (error) {
              console.log(`⚠️ Could not update PR status: ${error.message}`);
            }
